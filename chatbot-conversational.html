<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evelyn Partners - How Can We Help?</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ===== EVELYN PARTNERS BRAND COLORS ===== */
        :root {
            --jaguar: #11011B;
            --twine: #C69D64;
            --white: #FFFFFF;
            --light-gray: #F5F5F5;
            --border-gray: #E0E0E0;
            --text-gray: #666666;
            --error-red: #D32F2F;
            --success-green: #388E3C;
            --bot-message-bg: #FFFFFF;
            --user-message-bg: #C69D64;
        }

        /* ===== GLOBAL STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, var(--jaguar) 0%, #1a0a2e 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            line-height: 1.6;
            color: var(--jaguar);
        }

        /* ===== CHATBOT CONTAINER ===== */
        .chatbot-container {
            background: var(--white);
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
            height: 700px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===== HEADER ===== */
        .chatbot-header {
            background: var(--jaguar);
            color: var(--white);
            padding: 20px 24px;
            text-align: center;
            border-bottom: 3px solid var(--twine);
            flex-shrink: 0;
        }

        .chatbot-header h1 {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 4px;
            letter-spacing: 0.5px;
        }

        .chatbot-header p {
            font-size: 13px;
            opacity: 0.9;
        }

        /* ===== CHAT BODY ===== */
        .chatbot-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: var(--light-gray);
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .chatbot-body::-webkit-scrollbar {
            width: 8px;
        }

        .chatbot-body::-webkit-scrollbar-track {
            background: var(--light-gray);
        }

        .chatbot-body::-webkit-scrollbar-thumb {
            background: var(--twine);
            border-radius: 4px;
        }

        /* ===== MESSAGES ===== */
        .message {
            display: flex;
            margin-bottom: 8px;
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.bot {
            justify-content: flex-start;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-bubble {
            max-width: 75%;
            padding: 12px 16px;
            border-radius: 16px;
            position: relative;
        }

        .message.bot .message-bubble {
            background: var(--bot-message-bg);
            border: 1px solid var(--border-gray);
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .message.user .message-bubble {
            background: var(--user-message-bg);
            color: var(--white);
            border-bottom-right-radius: 4px;
        }

        .message-text {
            font-size: 15px;
            line-height: 1.5;
        }

        .message-text strong {
            font-weight: 600;
        }

        /* ===== TYPING INDICATOR ===== */
        .typing-indicator {
            display: none;
            padding: 12px 16px;
            background: var(--bot-message-bg);
            border: 1px solid var(--border-gray);
            border-radius: 16px;
            border-bottom-left-radius: 4px;
            max-width: 75px;
        }

        .typing-indicator.show {
            display: inline-block;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--twine);
            animation: typing 1.4s infinite;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* ===== INPUT AREA ===== */
        .chat-input-area {
            padding: 16px 20px;
            background: var(--white);
            border-top: 1px solid var(--border-gray);
            flex-shrink: 0;
        }

        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .input-field {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .input-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--jaguar);
            display: none;
        }

        .input-label.show {
            display: block;
        }

        .chat-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-gray);
            border-radius: 24px;
            font-size: 15px;
            font-family: inherit;
            transition: all 0.3s ease;
            background: var(--white);
            resize: none;
            max-height: 120px;
            min-height: 48px;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--twine);
            box-shadow: 0 0 0 3px rgba(198, 157, 100, 0.1);
        }

        .chat-input.error {
            border-color: var(--error-red);
        }

        .send-button {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--twine);
            color: var(--white);
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .send-button:hover:not(:disabled) {
            background: var(--jaguar);
            transform: scale(1.05);
        }

        .send-button:disabled {
            background: var(--border-gray);
            cursor: not-allowed;
        }

        /* ===== BUTTON OPTIONS ===== */
        .button-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
        }

        .option-btn {
            padding: 12px 16px;
            border: 2px solid var(--twine);
            background: var(--white);
            color: var(--jaguar);
            font-size: 14px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .option-btn i {
            color: var(--twine);
            font-size: 16px;
            min-width: 18px;
        }

        .option-btn:hover {
            background: var(--twine);
            color: var(--white);
            transform: translateX(4px);
        }

        .option-btn:hover i {
            color: var(--white);
        }

        /* ===== ERROR MESSAGE ===== */
        .error-message {
            color: var(--error-red);
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* ===== INFO BOX IN CHAT ===== */
        .info-box-message {
            background: rgba(198, 157, 100, 0.1);
            border-left: 4px solid var(--twine);
            padding: 12px;
            border-radius: 8px;
            margin-top: 8px;
            font-size: 14px;
        }

        .info-box-message h4 {
            color: var(--jaguar);
            font-size: 14px;
            margin-bottom: 6px;
        }

        .info-box-message ul {
            margin: 8px 0 0 16px;
            color: var(--text-gray);
        }

        .info-box-message li {
            margin-bottom: 4px;
            font-size: 13px;
        }

        /* ===== SUCCESS MESSAGE IN CHAT ===== */
        .success-box {
            background: var(--success-green);
            color: var(--white);
            padding: 12px 16px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .success-box i {
            font-size: 20px;
        }

        /* ===== RESTART BUTTON ===== */
        .restart-btn {
            background: var(--jaguar);
            color: var(--white);
            padding: 12px 24px;
            border: none;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
        }

        .restart-btn:hover {
            background: var(--twine);
            transform: translateY(-2px);
        }

        /* ===== CALENDLY EMBED ===== */
        .calendly-embed {
            width: 100%;
            min-height: 450px;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 12px;
        }

        /* ===== HIDDEN CLASS ===== */
        .hidden {
            display: none !important;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 640px) {
            .chatbot-container {
                border-radius: 0;
                height: 100vh;
                max-height: 100vh;
            }

            .chatbot-header h1 {
                font-size: 18px;
            }

            .message-bubble {
                max-width: 85%;
            }

            .chat-input {
                font-size: 16px; /* Prevent zoom on iOS */
            }
        }

        /* ===== LINK STYLING ===== */
        .message-link {
            color: var(--twine);
            text-decoration: underline;
            cursor: pointer;
        }

        .message.user .message-link {
            color: var(--white);
        }
    </style>
</head>
<body>
    <div class="chatbot-container">
        <div class="chatbot-header">
            <h1>Evelyn Partners</h1>
            <p>We're here to help</p>
        </div>

        <div class="chatbot-body" id="chatbotBody">
            <!-- Messages will be inserted here -->
        </div>

        <div class="chat-input-area">
            <div class="input-wrapper">
                <div class="input-field">
                    <label class="input-label" id="inputLabel"></label>
                    <input 
                        type="text" 
                        id="chatInput" 
                        class="chat-input" 
                        placeholder="Type your message..."
                        autocomplete="off"
                    >
                    <span class="error-message" id="errorMessage"></span>
                </div>
                <button class="send-button" id="sendButton" onclick="handleSend()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Calendly embed script -->
    <script type="text/javascript" src="https://assets.calendly.com/assets/external/widget.js"></script>

    <script>
        // ===== CONFIGURATION =====
        const CONFIG = {
            webhooks: {
                existingClient: 'https://your-n8n-instance.com/webhook/existing-client',
                prospectiveClient: 'https://your-n8n-instance.com/webhook/prospective-client',
                careers: 'https://your-n8n-instance.com/webhook/careers',
                press: 'https://your-n8n-instance.com/webhook/press',
                general: 'https://your-n8n-instance.com/webhook/general',
                inheritance: 'https://your-n8n-instance.com/webhook/inheritance'
            },
            catThreshold: 250000,
            calendlyUrl: 'https://calendly.com/your-team/consultation',
            typingDelay: 800 // milliseconds
        };

        // ===== STATE MANAGEMENT =====
        const state = {
            currentStep: 'welcome',
            currentFlow: null,
            userData: {},
            awaitingInput: false,
            currentField: null,
            conversationHistory: []
        };

        // ===== CONVERSATION FLOWS =====
        const flows = {
            'existing-client': [
                { field: 'name', question: 'May I have your full name, please?', type: 'text', required: true },
                { field: 'email', question: 'What\'s your email address?', type: 'email', required: true },
                { field: 'phone', question: 'And your phone number? (optional - press Enter to skip)', type: 'tel', required: false },
                { field: 'enquiryNature', question: 'How can we help you today?', type: 'select', required: true, 
                  options: [
                      { value: 'speak-to-advisor', label: 'Speak to My Advisor' },
                      { value: 'account-support', label: 'Account Support' },
                      { value: 'technical-issue', label: 'Technical Issue' },
                      { value: 'update-details', label: 'Update My Details' },
                      { value: 'inheritance', label: 'Inheritance/Executor Matter' },
                      { value: 'other', label: 'Other' }
                  ]
                }
            ],
            'prospective-client': [
                { field: 'name', question: 'Wonderful! Let\'s start with your name.', type: 'text', required: true },
                { field: 'email', question: 'What\'s your email address?', type: 'email', required: true },
                { field: 'phone', question: 'And your phone number? (optional - press Enter to skip)', type: 'tel', required: false },
                { field: 'investmentValue', question: 'To match you with the right team, what\'s your approximate investment value?', type: 'select', required: true,
                  options: [
                      { value: 'under-100k', label: 'Under £100,000' },
                      { value: '100k-250k', label: '£100,000 - £250,000' },
                      { value: '250k-500k', label: '£250,000 - £500,000' },
                      { value: '500k-1m', label: '£500,000 - £1,000,000' },
                      { value: 'over-1m', label: 'Over £1,000,000' },
                      { value: 'not-sure', label: 'I\'m not sure' }
                  ]
                }
            ],
            'careers': [
                { field: 'name', question: 'Great! Let\'s start with your name.', type: 'text', required: true },
                { field: 'email', question: 'What\'s your email address?', type: 'email', required: true },
                { field: 'phone', question: 'Your phone number? (optional)', type: 'tel', required: false },
                { field: 'interestArea', question: 'Which area interests you most?', type: 'select', required: true,
                  options: [
                      { value: 'regional-manager', label: 'Regional Manager Programme' },
                      { value: 'advisor', label: 'Advisor Roles' },
                      { value: 'support', label: 'Support Functions' },
                      { value: 'graduate', label: 'Graduate Schemes' },
                      { value: 'general', label: 'General Interest' }
                  ]
                },
                { field: 'message', question: 'Tell me a bit about yourself and your experience. (optional)', type: 'textarea', required: false }
            ],
            'press': [
                { field: 'name', question: 'May I have your name, please?', type: 'text', required: true },
                { field: 'email', question: 'Your email address?', type: 'email', required: true },
                { field: 'organization', question: 'Which publication or organization do you represent?', type: 'text', required: true },
                { field: 'phone', question: 'Your phone number? (optional)', type: 'tel', required: false },
                { field: 'enquiryDetails', question: 'What\'s your press enquiry about?', type: 'textarea', required: true }
            ],
            'general': [
                { field: 'name', question: 'May I have your name?', type: 'text', required: true },
                { field: 'email', question: 'Your email address?', type: 'email', required: true },
                { field: 'phone', question: 'Your phone number? (optional)', type: 'tel', required: false },
                { field: 'company', question: 'Are you enquiring on behalf of a company? If so, which one? (optional)', type: 'text', required: false },
                { field: 'enquiryType', question: 'What type of enquiry is this?', type: 'select', required: true,
                  options: [
                      { value: 'partnership', label: 'Partnership Opportunity' },
                      { value: 'corporate-services', label: 'Corporate Services' },
                      { value: 'complaint', label: 'Complaint' },
                      { value: 'feedback', label: 'Feedback' },
                      { value: 'other', label: 'Other' }
                  ]
                },
                { field: 'enquiryDetails', question: 'Please provide details about your enquiry.', type: 'textarea', required: true }
            ],
            'inheritance': [
                { field: 'deceasedName', question: 'I\'m very sorry for your loss. May I have the name of the deceased?', type: 'text', required: true },
                { field: 'relationship', question: 'What was your relationship to the deceased?', type: 'select', required: true,
                  options: [
                      { value: 'spouse', label: 'Spouse/Partner' },
                      { value: 'child', label: 'Child' },
                      { value: 'parent', label: 'Parent' },
                      { value: 'sibling', label: 'Sibling' },
                      { value: 'executor', label: 'Executor (not family)' },
                      { value: 'solicitor', label: 'Solicitor/Legal Representative' },
                      { value: 'other', label: 'Other' }
                  ]
                },
                { field: 'hasAuthority', question: 'Do you have legal authority to act on behalf of the estate?', type: 'select', required: true,
                  options: [
                      { value: 'yes', label: 'Yes, I have Grant of Probate or Letters of Administration' },
                      { value: 'pending', label: 'Application is pending' },
                      { value: 'no', label: 'No, not yet' },
                      { value: 'unsure', label: 'I\'m not sure' }
                  ]
                },
                { field: 'additionalInfo', question: 'Is there anything else you\'d like to add? (optional)', type: 'textarea', required: false }
            ]
        };

        // ===== UTILITY FUNCTIONS =====
        function scrollToBottom() {
            const chatBody = document.getElementById('chatbotBody');
            setTimeout(() => {
                chatBody.scrollTop = chatBody.scrollHeight;
            }, 100);
        }

        function showTypingIndicator() {
            const chatBody = document.getElementById('chatbotBody');
            const typingHTML = `
                <div class="message bot" id="typingIndicator">
                    <div class="typing-indicator show">
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
            `;
            chatBody.insertAdjacentHTML('beforeend', typingHTML);
            scrollToBottom();
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        function disableInput() {
            const input = document.getElementById('chatInput');
            const button = document.getElementById('sendButton');
            input.disabled = true;
            button.disabled = true;
        }

        function enableInput() {
            const input = document.getElementById('chatInput');
            const button = document.getElementById('sendButton');
            input.disabled = false;
            button.disabled = false;
            input.focus();
        }

        function clearInput() {
            const input = document.getElementById('chatInput');
            const errorMsg = document.getElementById('errorMessage');
            input.value = '';
            input.classList.remove('error');
            errorMsg.classList.remove('show');
            errorMsg.textContent = '';
        }

        function showError(message) {
            const input = document.getElementById('chatInput');
            const errorMsg = document.getElementById('errorMessage');
            input.classList.add('error');
            errorMsg.textContent = message;
            errorMsg.classList.add('show');
        }

        function validateInput(value, type, required) {
            if (required && !value.trim()) {
                return { valid: false, error: 'This field is required.' };
            }

            if (!value.trim() && !required) {
                return { valid: true };
            }

            if (type === 'email') {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(value)) {
                    return { valid: false, error: 'Please enter a valid email address.' };
                }
            }

            if (type === 'tel' && value.trim()) {
                const phoneRegex = /^[\d\s\+\-\(\)]+$/;
                if (!phoneRegex.test(value) || value.replace(/\D/g, '').length < 10) {
                    return { valid: false, error: 'Please enter a valid phone number.' };
                }
            }

            return { valid: true };
        }

        function getSessionId() {
            let sessionId = sessionStorage.getItem('chatbot_session_id');
            if (!sessionId) {
                sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                sessionStorage.setItem('chatbot_session_id', sessionId);
            }
            return sessionId;
        }

        async function sendToN8N(webhook, data) {
            try {
                const response = await fetch(webhook, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ...data,
                        timestamp: new Date().toISOString(),
                        sessionId: getSessionId()
                    })
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                return await response.json();
            } catch (error) {
                console.error('Error sending to n8n:', error);
                return { success: true }; // Mock success for demo
            }
        }

        // ===== MESSAGE FUNCTIONS =====
        function addBotMessage(text, includeButtons = false, buttons = []) {
            const chatBody = document.getElementById('chatbotBody');
            
            let messageHTML = `
                <div class="message bot">
                    <div class="message-bubble">
                        <div class="message-text">${text}</div>
            `;

            if (includeButtons && buttons.length > 0) {
                messageHTML += '<div class="button-options">';
                buttons.forEach(button => {
                    const icon = button.icon || 'fa-arrow-right';
                    messageHTML += `
                        <button class="option-btn" onclick="${button.action}">
                            <i class="fas ${icon}"></i>
                            <span>${button.text}</span>
                        </button>
                    `;
                });
                messageHTML += '</div>';
            }

            messageHTML += `
                    </div>
                </div>
            `;

            chatBody.insertAdjacentHTML('beforeend', messageHTML);
            scrollToBottom();
        }

        function addUserMessage(text) {
            const chatBody = document.getElementById('chatbotBody');
            const messageHTML = `
                <div class="message user">
                    <div class="message-bubble">
                        <div class="message-text">${text}</div>
                    </div>
                </div>
            `;
            chatBody.insertAdjacentHTML('beforeend', messageHTML);
            scrollToBottom();
        }

        function addInfoBox(title, content) {
            const chatBody = document.getElementById('chatbotBody');
            const messageHTML = `
                <div class="message bot">
                    <div class="message-bubble">
                        <div class="info-box-message">
                            <h4>${title}</h4>
                            ${content}
                        </div>
                    </div>
                </div>
            `;
            chatBody.insertAdjacentHTML('beforeend', messageHTML);
            scrollToBottom();
        }

        function addSuccessMessage(text) {
            const chatBody = document.getElementById('chatbotBody');
            const messageHTML = `
                <div class="message bot">
                    <div class="success-box">
                        <i class="fas fa-check-circle"></i>
                        <span>${text}</span>
                    </div>
                </div>
            `;
            chatBody.insertAdjacentHTML('beforeend', messageHTML);
            scrollToBottom();
        }

        // ===== CONVERSATION FLOW =====
        function startConversation() {
            const welcomeMessage = `Welcome to <strong>Evelyn Partners</strong>. How can we help you today?`;
            
            setTimeout(() => {
                addBotMessage(welcomeMessage, true, [
                    { text: "I'm an Existing Client", action: "selectFlow('existing-client')", icon: "fa-user-check" },
                    { text: "I'm Interested in Becoming a Client", action: "selectFlow('prospective-client')", icon: "fa-handshake" },
                    { text: "I'm Interested in Working with You", action: "selectFlow('careers')", icon: "fa-briefcase" },
                    { text: "I have a Press Enquiry", action: "selectFlow('press')", icon: "fa-newspaper" },
                    { text: "I have a General or Corporate Enquiry", action: "selectFlow('general')", icon: "fa-question-circle" }
                ]);
                disableInput();
            }, 500);
        }

        function selectFlow(flowName) {
            state.currentFlow = flowName;
            state.userData.enquiryType = flowName;
            state.currentStep = 0;

            // Add user's choice as a message
            const flowLabels = {
                'existing-client': "I'm an Existing Client",
                'prospective-client': "I'm Interested in Becoming a Client",
                'careers': "I'm Interested in Working with You",
                'press': "I have a Press Enquiry",
                'general': "I have a General or Corporate Enquiry"
            };
            
            addUserMessage(flowLabels[flowName]);

            // Show welcome message for the selected flow
            setTimeout(() => {
                let welcomeText = '';
                switch(flowName) {
                    case 'existing-client':
                        welcomeText = 'Welcome back! I\'ll need a few details to direct you to the right person.';
                        break;
                    case 'prospective-client':
                        welcomeText = 'Thank you for your interest! I\'ll ask you a few questions to understand your needs better.';
                        break;
                    case 'careers':
                        welcomeText = 'Excellent! We\'re always looking for talented people. Let me collect some information.';
                        break;
                    case 'press':
                        welcomeText = 'Thank you for reaching out. Let me gather the necessary information.';
                        break;
                    case 'general':
                        welcomeText = 'Thank you for contacting us. Let me collect some details about your enquiry.';
                        break;
                }
                
                showTypingIndicator();
                setTimeout(() => {
                    hideTypingIndicator();
                    addBotMessage(welcomeText);
                    askNextQuestion();
                }, CONFIG.typingDelay);
            }, 300);
        }

        function askNextQuestion() {
            const flow = flows[state.currentFlow];
            
            if (state.currentStep >= flow.length) {
                // All questions answered
                handleFlowCompletion();
                return;
            }

            const currentQuestion = flow[state.currentStep];
            state.currentField = currentQuestion;
            state.awaitingInput = true;

            showTypingIndicator();
            setTimeout(() => {
                hideTypingIndicator();

                if (currentQuestion.type === 'select') {
                    // Show as buttons
                    addBotMessage(currentQuestion.question, true, 
                        currentQuestion.options.map(opt => ({
                            text: opt.label,
                            action: `selectOption('${opt.value}', '${opt.label.replace(/'/g, "\\'")}')`,
                            icon: 'fa-check'
                        }))
                    );
                    disableInput();
                } else {
                    // Show as text input
                    addBotMessage(currentQuestion.question);
                    enableInput();
                    
                    const input = document.getElementById('chatInput');
                    input.placeholder = getPlaceholder(currentQuestion.type);
                    
                    if (currentQuestion.type === 'textarea') {
                        // For textarea questions, give a hint
                        input.placeholder = 'Type your response... (Press Enter to send)';
                    }
                }
            }, CONFIG.typingDelay);
        }

        function getPlaceholder(type) {
            switch(type) {
                case 'email': return 'your.email@example.com';
                case 'tel': return '+44 20 1234 5678';
                case 'textarea': return 'Type your message...';
                default: return 'Type your answer...';
            }
        }

        function selectOption(value, label) {
            if (!state.awaitingInput) return;

            addUserMessage(label);
            state.userData[state.currentField.field] = value;
            state.awaitingInput = false;

            // Check for special routing
            if (state.currentField.field === 'enquiryNature' && value === 'inheritance') {
                // Switch to inheritance flow
                setTimeout(() => {
                    showTypingIndicator();
                    setTimeout(() => {
                        hideTypingIndicator();
                        addBotMessage('I understand. Let me transfer you to our specialist team. I\'ll need some additional information.');
                        state.currentFlow = 'inheritance';
                        state.currentStep = 0;
                        askNextQuestion();
                    }, CONFIG.typingDelay);
                }, 300);
                return;
            }

            if (state.currentField.field === 'investmentValue') {
                // Determine routing
                const highValueRanges = ['250k-500k', '500k-1m', 'over-1m'];
                state.userData.routeTo = highValueRanges.includes(value) ? 'CAT' : 'general-services';
            }

            state.currentStep++;
            setTimeout(() => {
                askNextQuestion();
            }, 300);
        }

        function handleSend() {
            if (!state.awaitingInput) return;

            const input = document.getElementById('chatInput');
            const value = input.value.trim();

            // Validate
            const validation = validateInput(value, state.currentField.type, state.currentField.required);
            
            if (!validation.valid) {
                showError(validation.error);
                return;
            }

            // If optional and empty, use a placeholder
            const displayValue = value || '(skipped)';
            
            if (value) {
                addUserMessage(value);
                state.userData[state.currentField.field] = value;
            } else {
                addUserMessage('<em>Skipped</em>');
                state.userData[state.currentField.field] = '';
            }

            clearInput();
            disableInput();
            state.awaitingInput = false;

            state.currentStep++;
            setTimeout(() => {
                askNextQuestion();
            }, 300);
        }

        function handleFlowCompletion() {
            disableInput();
            
            // Handle special case: prospective client needs contact preference
            if (state.currentFlow === 'prospective-client' && !state.userData.contactMethod) {
                showTypingIndicator();
                setTimeout(() => {
                    hideTypingIndicator();
                    
                    const routeMessage = state.userData.routeTo === 'CAT' 
                        ? 'Based on your investment value, we\'ll connect you with our <strong>Centralized Relationship Team</strong> who specialize in comprehensive wealth management.'
                        : 'We\'d be happy to discuss how our services can help you achieve your financial goals.';
                    
                    addBotMessage(routeMessage);
                    
                    setTimeout(() => {
                        showTypingIndicator();
                        setTimeout(() => {
                            hideTypingIndicator();
                            addBotMessage('How would you like us to contact you?', true, [
                                { text: 'Email me with information', action: "selectContactMethod('email')", icon: 'fa-envelope' },
                                { text: 'Call me to discuss', action: "selectContactMethod('call')", icon: 'fa-phone' },
                                { text: 'Schedule a meeting', action: "selectContactMethod('schedule')", icon: 'fa-calendar' }
                            ]);
                        }, CONFIG.typingDelay);
                    }, 500);
                }, CONFIG.typingDelay);
                return;
            }

            // Submit data and show completion message
            submitData();
        }

        function selectContactMethod(method) {
            const labels = {
                'email': 'Email me with information',
                'call': 'Call me to discuss',
                'schedule': 'Schedule a meeting'
            };

            addUserMessage(labels[method]);
            state.userData.contactMethod = method;

            if (method === 'schedule') {
                showCalendly();
            } else {
                submitData();
            }
        }

        function showCalendly() {
            disableInput();
            
            showTypingIndicator();
            setTimeout(() => {
                hideTypingIndicator();
                addBotMessage('Perfect! Let me open our scheduling calendar for you.');
                
                // Send data to n8n first
                sendToN8N(CONFIG.webhooks[state.currentFlow], state.userData);

                const chatBody = document.getElementById('chatbotBody');
                const calendlyHTML = `
                    <div class="message bot">
                        <div class="message-bubble" style="max-width: 95%; padding: 8px;">
                            <div class="calendly-embed" id="calendlyEmbed"></div>
                        </div>
                    </div>
                `;
                chatBody.insertAdjacentHTML('beforeend', calendlyHTML);
                scrollToBottom();

                // Initialize Calendly
                Calendly.initInlineWidget({
                    url: CONFIG.calendlyUrl,
                    parentElement: document.getElementById('calendlyEmbed'),
                    prefill: {
                        name: state.userData.name,
                        email: state.userData.email
                    },
                    styles: {
                        height: '450px'
                    }
                });

                setTimeout(() => {
                    showTypingIndicator();
                    setTimeout(() => {
                        hideTypingIndicator();
                        addInfoBox('What happens next?', 
                            '<p>After booking, you\'ll receive a confirmation email with meeting details and a calendar invitation.</p>'
                        );
                        
                        addBotMessage('Once you\'ve scheduled your meeting, let me know!', true, [
                            { text: "I've scheduled my meeting", action: "confirmScheduled()", icon: 'fa-check' }
                        ]);
                    }, CONFIG.typingDelay);
                }, 1000);
            }, CONFIG.typingDelay);
        }

        function confirmScheduled() {
            addUserMessage("I've scheduled my meeting");
            state.userData.meetingScheduled = true;
            
            showTypingIndicator();
            setTimeout(() => {
                hideTypingIndicator();
                showFinalMessage(state.currentFlow + '-scheduled');
            }, CONFIG.typingDelay);
        }

        async function submitData() {
            disableInput();
            
            showTypingIndicator();
            
            // Determine webhook
            let webhook = CONFIG.webhooks[state.currentFlow];
            
            // Send to n8n
            await sendToN8N(webhook, state.userData);
            
            setTimeout(() => {
                hideTypingIndicator();
                showFinalMessage(state.currentFlow);
            }, CONFIG.typingDelay * 2);
        }

        function showFinalMessage(flowType) {
            let message = '';
            let infoTitle = 'What happens next?';
            let infoContent = '';

            const userName = state.userData.name ? state.userData.name.split(' ')[0] : 'there';

            switch(flowType) {
                case 'existing-client':
                    addBotMessage(`Thank you, <strong>${userName}</strong>. We've received your request and will be in touch shortly.`);
                    infoContent = '<p>You can expect to hear from us within <strong>1 business day</strong>. If your matter is urgent, please call us directly at <strong>020 7189 2400</strong>.</p>';
                    break;

                case 'prospective-client':
                    addBotMessage(`Thank you, <strong>${userName}</strong>! We're excited to potentially work with you.`);
                    const teamInfo = state.userData.routeTo === 'CAT' 
                        ? 'assign a dedicated relationship manager from our Centralized Relationship Team who will' 
                        : 'have someone from our team';
                    infoContent = `<p>Based on your investment profile, we'll ${teamInfo} contact you via your preferred method within <strong>2 business days</strong>.</p>`;
                    break;

                case 'prospective-client-scheduled':
                    addBotMessage('Perfect! Your consultation is confirmed.');
                    infoTitle = 'Before your meeting';
                    infoContent = `
                        <ul>
                            <li>You'll receive a calendar invitation and reminder</li>
                            <li>Feel free to prepare any questions you'd like to discuss</li>
                            <li>We'll send you helpful information about our services</li>
                        </ul>
                    `;
                    break;

                case 'careers':
                    addBotMessage(`Thank you, <strong>${userName}</strong>! We appreciate your interest in joining Evelyn Partners.`);
                    infoContent = '<p>Our HR team will review your information and contact you if there\'s a suitable opportunity. You can also explore current openings on our careers portal.</p>';
                    break;

                case 'press':
                    addBotMessage(`Thank you, <strong>${userName}</strong>. Your press enquiry has been received.`);
                    infoContent = '<p>Our press team will review your enquiry and respond as quickly as possible, typically within <strong>4 business hours</strong> during office hours.</p><p>For urgent press matters, please contact our press office directly at <strong>press@evelyn.com</strong></p>';
                    break;

                case 'general':
                    addBotMessage(`Thank you, <strong>${userName}</strong>. We've received your enquiry.`);
                    infoContent = '<p>Someone from our team will review your enquiry and respond within <strong>2 business days</strong>. If your matter requires urgent attention, please call us at <strong>020 7189 2400</strong>.</p>';
                    break;

                case 'inheritance':
                    addBotMessage(`Thank you, <strong>${userName}</strong>. We understand this is a sensitive time.`);
                    infoContent = '<p>A member of our bereavement services team will contact you within <strong>1 business day</strong> to discuss the next steps and what documentation may be required.</p><p>If you need immediate assistance, please call our bereavement helpline at <strong>020 7189 2500</strong>.</p>';
                    break;
            }

            setTimeout(() => {
                addSuccessMessage('Your information has been successfully submitted.');
                
                setTimeout(() => {
                    addInfoBox(infoTitle, infoContent);
                    
                    setTimeout(() => {
                        addBotMessage('Is there anything else I can help you with?', true, [
                            { text: 'Submit Another Enquiry', action: 'resetChatbot()', icon: 'fa-redo' },
                            { text: 'No, I\'m all set', action: 'endConversation()', icon: 'fa-check' }
                        ]);
                    }, 500);
                }, 500);
            }, 500);
        }

        function endConversation() {
            addUserMessage("No, I'm all set");
            
            setTimeout(() => {
                showTypingIndicator();
                setTimeout(() => {
                    hideTypingIndicator();
                    addBotMessage('Thank you for contacting <strong>Evelyn Partners</strong>. We look forward to speaking with you soon!');
                    disableInput();
                }, CONFIG.typingDelay);
            }, 300);
        }

        function resetChatbot() {
            addUserMessage('Submit Another Enquiry');
            
            state.currentStep = 'welcome';
            state.currentFlow = null;
            state.userData = {};
            state.awaitingInput = false;
            state.currentField = null;

            setTimeout(() => {
                showTypingIndicator();
                setTimeout(() => {
                    hideTypingIndicator();
                    addBotMessage('Of course! How can I help you?', true, [
                        { text: "I'm an Existing Client", action: "selectFlow('existing-client')", icon: "fa-user-check" },
                        { text: "I'm Interested in Becoming a Client", action: "selectFlow('prospective-client')", icon: "fa-handshake" },
                        { text: "I'm Interested in Working with You", action: "selectFlow('careers')", icon: "fa-briefcase" },
                        { text: "I have a Press Enquiry", action: "selectFlow('press')", icon: "fa-newspaper" },
                        { text: "I have a General or Corporate Enquiry", action: "selectFlow('general')", icon: "fa-question-circle" }
                    ]);
                    disableInput();
                }, CONFIG.typingDelay);
            }, 300);
        }

        // ===== EVENT LISTENERS =====
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSend();
            }
        });

        // ===== INITIALIZE =====
        document.addEventListener('DOMContentLoaded', function() {
            startConversation();
        });
    </script>
</body>
</html>